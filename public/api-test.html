<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #005a87;
        }
        .response {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .template-preview {
            border: 2px solid #007cba;
            border-radius: 8px;
            margin-top: 20px;
            min-height: 300px;
        }
        .template-preview iframe {
            width: 100%;
            height: 400px;
            border: none;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <h1>Display API Test Interface</h1>
    <p>This page allows you to test the display API endpoints for template management.</p>

    <div class="container">
        <h2>Display Configuration</h2>
        <div class="form-group">
            <label for="displayId">Display ID:</label>
            <input type="number" id="displayId" value="9" placeholder="Enter display ID">
        </div>
        <div class="form-group">
            <label for="connectionCode">Connection Code:</label>
            <input type="text" id="connectionCode" value="7241S" placeholder="Enter connection code">
        </div>
        <div class="form-group">
            <label for="macAddress">MAC Address:</label>
            <input type="text" id="macAddress" placeholder="Enter MAC address">
        </div>
    </div>

    <div class="container">
        <h2>API Tests</h2>
        
        <h3>1. Check for Active Template</h3>
        <button onclick="checkTemplate()">Check Template</button>
        <div id="checkResponse" class="response" style="display: none;"></div>

        <h3>2. Get Template Content</h3>
        <div class="form-group">
            <label for="templateId">Template ID:</label>
            <input type="number" id="templateId" placeholder="Enter template ID">
        </div>
        <button onclick="getTemplateContent()">Get Content</button>
        <div id="contentResponse" class="response" style="display: none;"></div>

        <h3>3. Report Display Status</h3>
        <div class="form-group">
            <label for="statusMessage">Status Message:</label>
            <input type="text" id="statusMessage" value="Test status update">
        </div>
        <div class="form-group">
            <label for="appVersion">App Version:</label>
            <input type="text" id="appVersion" value="1.0.0">
        </div>
        <div class="form-group">
            <label for="os">Operating System:</label>
            <input type="text" id="os" value="Tizen">
        </div>
        <button onclick="reportStatus()">Report Status</button>
        <div id="statusResponse" class="response" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>Template Preview</h2>
        <p>If a template is found, it will be displayed below:</p>
        <div id="templatePreview" class="template-preview" style="display: none;">
            <iframe id="previewFrame"></iframe>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api/display';

        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = 'response ' + (isError ? 'error' : 'success');
            element.textContent = JSON.stringify(data, null, 2);
        }

        async function checkTemplate() {
            const displayId = document.getElementById('displayId').value;
            const connectionCode = document.getElementById('connectionCode').value;
            const macAddress = document.getElementById('macAddress').value;

            let url = API_BASE + '/template/check?';
            const params = new URLSearchParams();
            
            if (displayId) params.append('display_id', displayId);
            if (connectionCode) params.append('connection_code', connectionCode);
            if (macAddress) params.append('mac_address', macAddress);

            url += params.toString();

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                showResponse('checkResponse', data, !data.success);
                
                // If template found, show preview and populate template ID
                if (data.success && data.has_template) {
                    document.getElementById('templateId').value = data.template.id;
                    showTemplatePreview(data.template.preview_url);
                } else {
                    hideTemplatePreview();
                }
            } catch (error) {
                showResponse('checkResponse', { error: error.message }, true);
            }
        }

        async function getTemplateContent() {
            const templateId = document.getElementById('templateId').value;
            const displayId = document.getElementById('displayId').value;

            if (!templateId || !displayId) {
                showResponse('contentResponse', { error: 'Template ID and Display ID are required' }, true);
                return;
            }

            const url = `${API_BASE}/template/content?template_id=${templateId}&display_id=${displayId}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                showResponse('contentResponse', data, !data.success);
            } catch (error) {
                showResponse('contentResponse', { error: error.message }, true);
            }
        }

        async function reportStatus() {
            const displayId = document.getElementById('displayId').value;
            const connectionCode = document.getElementById('connectionCode').value;
            const macAddress = document.getElementById('macAddress').value;
            const message = document.getElementById('statusMessage').value;
            const appVersion = document.getElementById('appVersion').value;
            const os = document.getElementById('os').value;

            const data = {
                message: message,
                app_version: appVersion,
                os: os,
                capabilities: ['video', 'audio', 'touch']
            };

            if (displayId) data.display_id = displayId;
            if (connectionCode) data.connection_code = connectionCode;
            if (macAddress) data.mac_address = macAddress;

            try {
                const response = await fetch(API_BASE + '/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showResponse('statusResponse', result, !result.success);
            } catch (error) {
                showResponse('statusResponse', { error: error.message }, true);
            }
        }

        function showTemplatePreview(previewUrl) {
            const preview = document.getElementById('templatePreview');
            const frame = document.getElementById('previewFrame');
            frame.src = previewUrl;
            preview.style.display = 'block';
        }

        function hideTemplatePreview() {
            const preview = document.getElementById('templatePreview');
            preview.style.display = 'none';
        }

        // Auto-check for template on page load
        window.addEventListener('load', () => {
            checkTemplate();
        });
    </script>
</body>
</html>
